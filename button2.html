<html>
<head>
  <meta name="google-signin-client_id" content="561322356328-85re3ua1e0fb83sleqhr9n2n708ofu46.apps.googleusercontent.com">
</head>
<body>
  <div id="my-signin2" data-width="240" data-height="50" data-longtitle="true"></div>
  <script>
    function onSuccess(googleUser) {
      console.log('Logged in as: ' + googleUser.getBasicProfile().getName());
      gapi.load('client', async () => {
        try {
            await gapi.client.init({
                apiKey: 'AIzaSyBp3CjYhd3HSd7wRUYp2WkutEk-7BTucWM',
                clientId: document.querySelector('[name="google-signin-client_id"]').getAttribute('content'),
                discoveryDocs: [
                    'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest',
                ],
                scope: 'https://www.googleapis.com/auth/youtube.readonly',
            });
            console.log("GAPI client for YouTube loaded.");
            fetchYouTubeSubscriptions();
        } catch (err) {
            console.error("Error loading GAPI client for YouTube: ", err);
        }
      });
    }
    function onFailure(error) {
      console.log(error);
    }
    function renderButton() {
      gapi.signin2.render('my-signin2', {
        'scope': 'profile email https://www.googleapis.com/auth/youtube.readonly',
        'width': 240,
        'height': 50,
        'longtitle': true,
        'theme': 'dark',
        'onsuccess': onSuccess,
        'onfailure': onFailure
      });
    }
    function fetchYouTubeSubscriptions(pageToken) {
        gapi.client.load('youtube', 'v3', function() {
            var requestOptions = {
                part: 'snippet',
                mine: true,
                maxResults: 50
            };
            if (pageToken) {
                requestOptions.pageToken = pageToken;
            }
            gapi.client.youtube.subscriptions.list(requestOptions).then(function(response) {
                console.log(response.result);
                var subscriptions = response.result.items;
                var output = document.body.innerHTML;
                if (!output.includes('<h2>Your Subscriptions</h2>')) {
                    output += '<h2>Your Subscriptions</h2><ul>';
                }
                subscriptions.forEach(function(subscription) {
                    output += '<li>' + subscription.snippet.title + '</li>';
                });

                if (response.result.nextPageToken) {
                    fetchYouTubeSubscriptions(response.result.nextPageToken);
                } else {
                    output += '</ul>';
                }
                document.body.innerHTML = output;
            });
        });
    }
  </script>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
</body>
</html>
